<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Clean Region</title>
    <script src="js/fabric.js"></script>
</head>
<body>
<div>
    <button onclick="addRegion()">添加区域</button>
    <button id="btnCompleteRegion" onclick="completeRegion()" disabled>完成</button>
    <button onclick="getRegion()">获取区域</button>
    <button onclick="getCircle()">获取圆点</button>
</div>
<div style="border: 1px solid gray;width: 500px">
    <canvas id="c" width="500" height="500"></canvas>
</div>
</body>
</html>
<style type="text/css">
    button {
        margin: 10px 20px;
    }
</style>
<script type="text/javascript">
    var deleteIcon = "data:image/svg+xml,%3C%3Fxml version='1.0' encoding='utf-8'%3F%3E%3C!DOCTYPE svg PUBLIC '-//W3C//DTD SVG 1.1//EN' 'http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd'%3E%3Csvg version='1.1' id='Ebene_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' width='595.275px' height='595.275px' viewBox='200 215 230 470' xml:space='preserve'%3E%3Ccircle style='fill:%23F44336;' cx='299.76' cy='439.067' r='218.516'/%3E%3Cg%3E%3Crect x='267.162' y='307.978' transform='matrix(0.7071 -0.7071 0.7071 0.7071 -222.6202 340.6915)' style='fill:white;' width='65.545' height='262.18'/%3E%3Crect x='266.988' y='308.153' transform='matrix(0.7071 0.7071 -0.7071 0.7071 398.3889 -83.3116)' style='fill:white;' width='65.544' height='262.179'/%3E%3C/g%3E%3C/svg%3E";
    var deleteImg = document.createElement('img');
    deleteImg.src = deleteIcon;

    var addIcon = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAuNJREFUWEfNlz9oE3EUx7/vYtNWi7pIUEQURwe1TVJ0sR1EEdtchnaw16KLioI66OBkRXBRcNL6DwRztcUOl1apBQcLItVcqlCok6CgRDQuWhtNSO7JVZPeJWnvlwQSb37v/T6/7/vze0eo8Uc1Ph/CADsOa2vdabQxSXvA7AfgIcDDIAJzHMRxgHSSpCeZhsbn07f3fhe5nCPAtq6H7pX17lMATgPYKBIUQIzBdxiNt6bV/Z+X81kWwHtI85MkDQDcLHhwvlmMiC5FQoGbS/kvCeDvGzvIhvGozINtbgy+GFWD/cViFQXw9o6dITauORw+aQZ2MX3NEHcT6MKyUktSR+R+5+N8mwIAv6LJDNKcbs7g9qganDTtvIrWRqBnjj4Gt0YfBCNWOxvA34KrnxLJua7KNl+fEmYnAIBeJ5LJXbMj3amsbX6QswCuOAcCygNYiHxOV+WrBQCtPeOrDUrNirZaBQCf0nXu5jf3DsRNiJwC/t7wPmZMiNzetKkAAGCc1AflGzYAX492GUTnqwIATOqq3G4HUMIvAOyuEgASyVS9WYy5FPiU8DsAWy0AC32ebTVRsHy7FmViPeHXsYI5kcYmfVj+uFgDSniOgaZsAGufl3t41q/YnCAiXyQUiFoUGP0J8KpqAYAlvz7YqS8C9ITfg7C5WilwpXnLy+HgB4sCWgQgn6jcFbUhgCT9aJoJ9c1bi/A6gBPVAGBgJqrK2+2DqMTnt0IFcuM4p0DL0adrpMT8WwAbRFSoACAmZaj51VDgi02Bf89qv9O7noUrFyB/ObG9hubQkPA7KqJCmQAxAw1e655YuJD0jh5n5gGnNJSzkBBRdyQUGFlyIbFMLpFUlLSSAaToamAw/2L/51KaU6KWa3kWoqY/JtZ87Twyvm5FKtUFQheAtqJFSphig+6yIY1ND3V8cyrkgjkg4mDaLKjicnuojjxsELkymXiibi5uznbRGFk7x3/DUgOWav8HEtBgMITdcBIAAAAASUVORK5CYII="
    var addImg = document.createElement('img');
    addImg.src = addIcon;

    let regionPoints = []
    let mouseDownOption = null
    let regionAdding = false
    let rid = `region-${new Date().getTime()}`;

    fabric.Object.prototype.originX = fabric.Object.prototype.originY = 'center';
    fabric.Object.prototype.transparentCorners = false;
    fabric.Object.prototype.cornerColor = 'blue';
    fabric.Object.prototype.cornerStyle = 'circle';
    fabric.Object.prototype.borderScaleFactor = 3//选中后的边框宽度
    fabric.Object.prototype.borderColor = '#0048ff'

    fabricCanvas = new fabric.Canvas('c', {
        selection: false
    });

    fabricCanvas.on('mouse:down', opt => {
        mouseDownOption = opt
    })
    fabricCanvas.on('mouse:up', opt => {
        if (mouseDownOption.target == null) { //未选中时再触发
            if (opt.pointer.x == mouseDownOption.pointer.x &&
                opt.pointer.y == mouseDownOption.pointer.y) {
                canvasMouseDown(opt)
            }
        } else {

        }
        mouseDownOption = null
    })

    fabricCanvas.on('object:moving', function (opt) {
        // 当前移动的元素
        //let target = e.target
        let obj = opt.target
        let canvasBoundaries = fabricCanvas.calcViewportBoundaries()

        let repair = false
        //检查是否移动出画布
        if (obj.left < canvasBoundaries.tl.x) {
            obj.set({
                left: canvasBoundaries.tl.x
            })
            repair = true
        }

        if (obj.left > canvasBoundaries.br.x) {
            obj.set({
                left: canvasBoundaries.br.x
            })
            repair = true
        }

        if (obj.top < canvasBoundaries.tl.y) {
            obj.set({
                top: canvasBoundaries.tl.y
            })
            repair = true
        }

        if (obj.top > canvasBoundaries.br.y) {
            obj.set({
                top: canvasBoundaries.br.y
            })
            repair = true
        }
        if (repair) {
            console.info(repair)
            obj.setCoords()
        }
        adjustingPolygonPoint(obj, true)
    })

    fabricCanvas.on('selection:created', opt => {
        //console.info(opt.selected[0].type)
        if (opt.selected[0].type == 'polygon') {//circle

        }
        console.info(opt)
    })
    fabricCanvas.on('selection:updated', opt => {
        console.info(opt)
        if (opt.selected[0].type == 'polygon') {

        }
        if (opt.deselected[0].type == 'polygon') {//circle

        }
    })
    fabricCanvas.on('selection:cleared', opt => {
        if (opt.deselected && opt.deselected[0].type == 'polygon') {//circle

        }
    })

    function renderIcon(icon) {
        return function renderIcon(ctx, left, top, styleOverride, fabricObject) {
            var size = this.cornerSize;
            ctx.save();
            ctx.translate(left, top);
            ctx.rotate(fabric.util.degreesToRadians(fabricObject.angle));
            ctx.drawImage(icon, -size / 2, -size / 2, size, size);
            ctx.restore();
            //console.info(arguments)
        }
    }

    function deleteObject(eventData, transform) {
        if (confirm("确定删除吗?")) {
            var target = transform.target;
            var canvas = target.canvas;
            canvas.remove(target);

            canvas.getObjects('text').forEach(item => {
                if (item.rid == target.rid) {
                    canvas.remove(item);
                }
            })
            canvas.getObjects('circle').forEach(item => {
                if (item.rid == target.rid) {
                    canvas.remove(item);
                }
            })
            canvas.requestRenderAll();
        }
    }

    fabric.Polygon.prototype.controls = {}
    //fabric.Polygon.prototype.controls.mtr  = fabric.Object.prototype.controls.mtr
    fabric.Polygon.prototype.controls.deleteControl = new fabric.Control({
        x: 0.5,
        y: -0.5,
        offsetY: 16,
        cursorStyle: 'pointer',
        mouseUpHandler: deleteObject,
        render: renderIcon(deleteImg),
        cornerSize: 24
    });

    fabric.Circle.prototype.controls = {}
    //fabric.Polygon.prototype.controls.mtr  = fabric.Object.prototype.controls.mtr
    fabric.Circle.prototype.controls.deleteControl = new fabric.Control({
        x: 0,
        y: 0.4,
        offsetY: 16,
        cursorStyle: 'pointer',
        mouseUpHandler: deleteObject,
        render: renderIcon(deleteImg),
        cornerSize: 24
    });
    fabric.Circle.prototype.controls.leftAddControl = new fabric.Control({
        x: -1.2,
        y: 0,
        cursorStyle: 'pointer',
        mouseUpHandler: deleteObject,
        render: renderIcon(addImg),
        cornerSize: 24
    });
    fabric.Circle.prototype.controls.rightAddControl = new fabric.Control({
        x: 1.2,
        y: 0,
        cursorStyle: 'pointer',
        mouseUpHandler: deleteObject,
        render: renderIcon(addImg),
        cornerSize: 24
    });

    /**
     * 选中多边形
     */
    function activePolygon(polygon) {

    }

    /**
     * 取消选中多边形
     */
    function deactivePolygon(polygon) {

    }

    /**
     * 调整多边形点
     */
    function adjustingPolygonPoint(target, setPD) {
        // 判断是多边形点
        if ('cid' in target && target.cid.match(RegExp(/circle-/))) {
            let index = target.cid.split('-')[1] // 获取cid
            if (target.completedPolygon) {//已完成的多边形
                let polygon = fabricCanvas.getObjects('polygon').filter(item => item.rid == target.rid)[0]
                let points = polygon.points // 获取多边形的点
                points[index].x = target.left // 修改指定顶点的x坐标
                points[index].y = target.top // 修改指定定点的y坐标

                let centerPoint = getPolygonCenter(points)
                fabricCanvas.getObjects('text').filter(item => item.rid == target.rid)[0].set({
                    left: centerPoint.x,
                    top: centerPoint.y
                })
                fabricCanvas.renderAll() // 刷新画布
                if (setPD) {
                    polygon._setPositionDimensions({})
                }
            } else {//创建中的多边形
                let tempLineList = fabricCanvas.getObjects('line').filter(item => item.tag == 'tempLine')
                regionPoints[index] = {
                    x: target.left,
                    y: target.top
                }
                if (tempLineList.length > 0) {
                    let prveLineIndex = index - 1
                    if (prveLineIndex >= 0) {//前一条线
                        tempLineList[prveLineIndex].set({
                            x2: target.left,
                            y2: target.top
                        }).setCoords()
                    }
                    if (index != tempLineList.length) {//后一条线
                        tempLineList[index].set({
                            x1: target.left,
                            y1: target.top
                        }).setCoords()
                    }
                }
            }
        }
    }

    function addRegion() {
        regionPoints = []
        regionAdding = true
        document.getElementById('btnCompleteRegion').disabled = true
    }

    function completeRegion() {
        document.getElementById('btnCompleteRegion').disabled = true
        regionAdding = false
        //删除临时线
        fabricCanvas.getObjects('line').forEach(item => {
            if (item.tag == 'tempLine') {
                fabricCanvas.remove(item)
            }
        })

        //添加polyline
        // 多边形
        const polygon = new fabric.Polygon(
            regionPoints, // 顶点坐标集
            {
                fill: '#d5ece0', // 填充红色
                stroke: 'black', // 边框黑色
                strokeWidth: 1, // 边框粗细
                objectCaching: false, // 当“true”时，对象缓存在另一个画布上。当“false”时，除非必要(clipPath)默认为 true，否则不缓存对象。默认是true
                //selectable: false, // 禁止选中
                //evented: false, // 当设置为“false”时，对象不能成为事件的目标。所有事件都会通过它传播。
                rid: rid,
                lockMovementX: true,
                lockMovementY: true,
                lockRotation: true,
                lockScalingX: true,
                lockScalingY: true,
                //hasControls: false,
            }
        )
        fabricCanvas.add(polygon)

        let centerPoint = getPolygonCenter(regionPoints)
        //console.info(centerPoint)
        //添加命名
        let text = new fabric.Text('区域' + rid.substring(rid.length - 3, rid.length), {
            left: centerPoint.x,
            top: centerPoint.y,
            fontSize: 16,
            selectable: false,
            evented: false,
            rid: rid,
        })
        fabricCanvas.add(text)

        fabricCanvas.getObjects('circle').forEach(item => {
            if (item.rid == rid) {
                item.set({
                    completedPolygon: true//完成多边形
                })
                item.bringToFront()
            }
        })

        regionPoints = []
        rid = `region-${new Date().getTime()}`


    }

    function addCircle(p) {
        let cc = new fabric.Circle({
            left: p.x,
            top: p.y,
            strokeWidth: 3,
            radius: 8,
            fill: '#fff',
            stroke: '#666',
            lockRotation: true,
            lockScalingX: true,
            lockScalingY: true,
            //transparentCorners: true,
            cornerStyle: 'rect',
            rid: rid,
            cid: `circle-${regionPoints.length - 1}`, // 自定义属性
            completedPolygon: false//完成多边形
        })
        fabricCanvas.add(cc)
        let cList = fabricCanvas.getObjects('circle').filter(item => item.rid == rid);
        cList.forEach((item, index) => {
            item.setControlsVisibility({
                leftAddControl: index != 0,
                rightAddControl: index != cList.length - 1
            })
            console.info(index != cList.length - 1)
        })
        if (regionPoints.length >= 2) {
            addLine(regionPoints[regionPoints.length - 2], p)
        }
    }

    function addLine(p1, p2) {
        let _line = new fabric.Line([p1.x, p1.y,
            p2.x, p2.y
        ], {
            stroke: 'black',
            selectable: false,
            tag: 'tempLine',
            evented: false,
        })
        fabricCanvas.add(_line)
    }

    function canvasMouseDown(opt) {
        let point = fabricCanvas.getPointer(opt.e)
        //console.info(point, point.x, point.y)
        if (regionAdding) {
            regionPoints.push(point)
            addCircle(point)
            if (regionPoints.length >= 3) {
                document.getElementById('btnCompleteRegion').disabled = false
            }
        }
    }

    /**
     * 获取多边形中心点
     * @param {Point[]} points 点坐标数组 [{x:0,y:0}...]
     */
    function getPolygonCenter(points) {
        if (!Array.isArray(points) || points.length < 3) {
            console.error("多边形坐标集合不能少于3个");
            return;
        }
        const result = {x: 0, y: 0};
        points.forEach((p) => {
            result.x += p.x;
            result.y += p.y;
        });
        result.x /= points.length;
        result.y /= points.length;
        return result;
    }

    function getRegion() {
        fabricCanvas.getObjects('polygon').forEach(item => {
            console.info(item)
        })
    }

    function getCircle() {
        fabricCanvas.getObjects('circle').forEach(item => {
            console.info(item)
        })
    }

</script>